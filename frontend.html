<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mumbai Crime Prediction Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #controls {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1001;
      background: white;
      padding: 14px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      width: 230px;
    }

    #loader {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.45);
      z-index: 2000;
      color: white;
      font-weight: 600;
      font-size: 1.1rem;
      visibility: hidden;
    }

    /* Legend box */
    .legend {
      position: absolute;
      bottom: 15px;
      right: 15px;
      z-index: 1001;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-family: Inter, sans-serif;
      font-size: 13px;
      line-height: 1.3;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    .legend-color {
      width: 14px;
      height: 14px;
      margin-right: 6px;
      border-radius: 3px;
    }
  </style>
</head>

<body class="antialiased bg-gray-50">

  <!-- Control Panel -->
  <div id="controls">
    <label class="block mb-2 font-semibold text-sm">Select Month:</label>
    <select id="monthSelect" class="p-2 border rounded w-full mb-3"></select>

    <div class="flex gap-2">
      <button id="predictBtn" class="flex-1 bg-orange-500 text-white px-3 py-2 rounded hover:bg-orange-600 focus:ring-2 focus:ring-orange-400">
        Predict
      </button>
      <button id="fitBtn" class="flex-1 bg-gray-200 px-3 py-2 rounded hover:bg-gray-300 focus:ring-2 focus:ring-gray-300">
        Fit Map
      </button>
    </div>

    <div id="status" class="mt-3 text-xs text-gray-600"></div>
  </div>

  <!-- Legend -->
  <div class="legend">
    <div class="font-semibold mb-1 text-gray-700">Crime Risk</div>
    <div class="legend-item"><div class="legend-color" style="background:#22C55E;"></div>Low</div>
    <div class="legend-item"><div class="legend-color" style="background:#FACC15;"></div>Moderate</div>
    <div class="legend-item"><div class="legend-color" style="background:#F97316;"></div>High</div>
    <div class="legend-item"><div class="legend-color" style="background:#9CA3AF;"></div>No Data</div>
  </div>

  <div id="map"></div>
  <div id="loader">Loading prediction map…</div>

<script>
/* === CONFIGURATION === */
const API_BASE = "http://localhost:5000"; // Flask backend
const MAP_CENTER = [19.076, 72.8777]; // Mumbai
const MAP_ZOOM = 11;
const FUTURE_START = new Date("2025-09-01");
const FUTURE_END = new Date("2026-12-01");

/* === ELEMENTS === */
const loader = document.getElementById("loader");
const monthSelect = document.getElementById("monthSelect");
const predictBtn = document.getElementById("predictBtn");
const fitBtn = document.getElementById("fitBtn");
const status = document.getElementById("status");

/* === MAP === */
const map = L.map("map").setView(MAP_CENTER, MAP_ZOOM);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let geoJsonLayer = null;

/* === UI HELPERS === */
function showLoader(msg = "Loading...") {
  loader.textContent = msg;
  loader.style.visibility = "visible";
}
function hideLoader() {
  loader.style.visibility = "hidden";
}
function escapeHtml(str) {
  return ("" + str).replace(/[&<>"']/g, c =>
    ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c])
  );
}

/* === MONTH SELECTION === */
function populateFutureMonths() {
  let date = new Date(FUTURE_START);
  while (date <= FUTURE_END) {
    const end = new Date(date.getFullYear(), date.getMonth() + 1, 0);
    const opt = document.createElement("option");
    opt.value = end.toISOString().split("T")[0];
    opt.text = `${date.toLocaleString("default", { month: "short" })} ${date.getFullYear()}`;
    monthSelect.appendChild(opt);
    date.setMonth(date.getMonth() + 1);
  }
  monthSelect.value = monthSelect.options[0].value;
}

/* === FETCH + RENDER === */
async function fetchPrediction() {
  const month = monthSelect.value;
  if (!month) return;

  showLoader(`Predicting crimes for ${month}...`);
  status.textContent = `Fetching predictions for ${month}...`;

  try {
    const res = await fetch(`${API_BASE}/get_crime_map?month=${month}`);
    if (!res.ok) throw new Error(`Server error: ${res.status}`);
    const geo = await res.json();

    // Remove old layers
    if (geoJsonLayer) {
      map.removeLayer(geoJsonLayer);
      geoJsonLayer = null;
    }

    if (!geo.features || geo.features.length === 0) {
      hideLoader();
      alert("No zones returned for this date — check backend output.");
      return;
    }

    // Filter invalid geometries
    const validFeatures = geo.features.filter(
      f => f.geometry && f.geometry.coordinates && f.geometry.coordinates.length > 0
    );

    geoJsonLayer = L.geoJSON(validFeatures, {
      style: f => ({
        color: "#ffffff",
        weight: 1,
        fillColor: f.properties?.color_zone || "#9CA3AF",
        fillOpacity: 0.75
      }),
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        const station = p.Police_Station_Coords || p.history_name || "Unknown Station";
        const crime = Math.round(p.crime ?? 0);
        const type = p.data_type || "Predicted";
        layer.bindPopup(
          `<div style="font-family:Inter,sans-serif;font-size:13px">
             <b>${escapeHtml(station)}</b><br/>
             <b>${escapeHtml(type)}:</b> ${escapeHtml(crime)}
           </div>`
        );
      }
    }).addTo(map);

    fitMapToZones();
    status.textContent = `Rendered ${validFeatures.length} Voronoi zones for ${month}.`;
  } catch (err) {
    console.error(err);
    alert("Error fetching predictions: " + err.message);
    status.textContent = `Error: ${err.message}`;
  } finally {
    hideLoader();
  }
}

/* === FIT MAP (always works) === */
function fitMapToZones() {
  if (geoJsonLayer) {
    try {
      const bounds = geoJsonLayer.getBounds();
      if (bounds && bounds.isValid()) {
        map.fitBounds(bounds, { padding: [40, 40] });
        return;
      }
    } catch (e) {
      console.warn("⚠️ Could not compute bounds:", e);
    }
  }
  console.warn("⚠️ No valid zones to fit to; resetting to default view.");
  map.setView(MAP_CENTER, MAP_ZOOM);
}

/* === EVENT HANDLERS === */
predictBtn.addEventListener("click", fetchPrediction);
fitBtn.addEventListener("click", fitMapToZones);
monthSelect.addEventListener("change", () => {
  status.textContent = `Selected ${monthSelect.options[monthSelect.selectedIndex].text}`;
});

/* === INIT === */
populateFutureMonths();
fetchPrediction();
</script>
</body>
</html>
